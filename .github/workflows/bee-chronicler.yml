name: "[⬢⬡⬢⬡] Jekyll Static Site Generation"

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/jekyll-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Setup Pages
      uses: actions/configure-pages@v3
      
    - name: Install Jekyll dependencies
      run: |
        gem install jekyll bundler
        bundle init
        bundle add jekyll
        bundle add jekyll-theme-minimal
        
    - name: Create Jekyll configuration
      run: |
        cat > _config.yml << EOF
        title: "🔲⬢⬡⬢⬡ Hive Living Mirror Documentation"
        description: "🔲 Pure Core • [⬢⬡⬢⬡] Enhanced Features • 🍯 Honeypot Architecture"
        baseurl: ""
        url: "https://zaebee.github.io/chat"
        
        markdown: kramdown
        highlighter: rouge
        theme: minima
        
        plugins:
          - jekyll-feed
          - jekyll-sitemap
          - jekyll-seo-tag
        
        # Collections
        collections:
          foundation:
            output: true
            permalink: /:collection/:name/
          architecture:
            output: true
            permalink: /:collection/:name/
          development:
            output: true
            permalink: /:collection/:name/
          api:
            output: true
            permalink: /:collection/:name/
          sacred-team:
            output: true
            permalink: /:collection/:name/
        
        # Defaults
        defaults:
          - scope:
              path: ""
              type: "pages"
            values:
              layout: "default"
          - scope:
              path: "docs"
            values:
              layout: "page"
        EOF
        
    - name: Copy docs to Jekyll source
      run: |
        cp -r docs/* .
        
    - name: Add Jekyll enhancements
      run: |
        # Create layouts directory
        mkdir -p _layouts _includes
        
        # Create default layout
        cat > _layouts/default.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>{{ page.title | default: site.title }}</title>
          <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
        </head>
        <body>
          <header>
            <nav>
              <a href="{{ '/' | relative_url }}">🏠 Home</a>
              <a href="{{ '/00_FOUNDATION/' | relative_url }}">🔲 Foundation</a>
              <a href="{{ '/01_ARCHITECTURE/' | relative_url }}">⬢⬡⬢⬡ Architecture</a>
              <a href="{{ '/02_DEVELOPMENT/' | relative_url }}">🔧 Development</a>
              <a href="{{ '/03_API/' | relative_url }}">🔌 API</a>
              <a href="{{ '/sacred-team/' | relative_url }}">🐝 Sacred Team</a>
            </nav>
          </header>
          <main>
            {{ content }}
          </main>
          <footer>
            <p>🔲 Pure Honeypot Core • [⬢⬡⬢⬡] Enhanced by Jekyll • 🍯 No Dirty Mixing</p>
          </footer>
        </body>
        </html>
        EOF
        
        # Create page layout
        cat > _layouts/page.html << 'EOF'
        ---
        layout: default
        ---
        <article>
          <header>
            <h1>{{ page.title }}</h1>
            {% if page.description %}
            <p class="description">{{ page.description }}</p>
            {% endif %}
          </header>
          {{ content }}
        </article>
        EOF
        
    - name: Build Jekyll site
      run: |
        bundle exec jekyll build
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./_site
        
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2