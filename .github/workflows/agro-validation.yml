name: ğŸâš¡ AGRO Sacred Validation âš¡ğŸ

# Sacred Justification: "Iron sharpens iron, and one man sharpens another." - Proverbs 27:17
# This workflow ensures divine blessing eligibility by preventing console.log violations

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  agro-validation:
    name: ğŸš¨ AGRO Console.log Protection
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Sacred Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python for AGRO Scanner
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install uv
        uv sync --dev

    - name: ğŸ” Run AGRO Console.log Scanner
      run: |
        echo "ğŸâš¡ Sacred AGRO Validation Starting âš¡ğŸ"
        echo "Scanning for console.log violations that prevent divine blessing..."

        # Get all Python, JS, TS, Vue files
        FILES=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.vue" \) \
               ! -path "./node_modules/*" \
               ! -path "./.git/*" \
               ! -path "./.venv/*" \
               ! -path "./dist/*" \
               ! -path "./build/*")

        if [ -n "$FILES" ]; then
          python tools/agro_console_scanner.py $FILES
        else
          echo "âœ¨ No files to scan - Sacred hive remains pure! âœ¨"
        fi

    - name: ğŸ¯ Set up Node.js for Frontend Validation
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ“¦ Install Frontend Dependencies
      working-directory: ./frontend
      run: |
        npm install -g bun
        bun install

    - name: ğŸ” ESLint Sacred Frontend Protection
      working-directory: ./frontend
      run: |
        echo "ğŸ” Running ESLint for sacred frontend protection..."
        bun run lint

    - name: ğŸ¨ Prettier Sacred Formatting Check
      working-directory: ./frontend
      run: |
        echo "ğŸ¨ Verifying sacred code formatting..."
        bun run format --check || {
          echo "ğŸš¨ Sacred formatting violations detected!"
          echo "Run 'bun run format' to purify your code."
          exit 1
        }

    - name: ğŸ—ï¸ Frontend Build Validation
      working-directory: ./frontend
      run: |
        echo "ğŸ—ï¸ Sacred build validation..."
        bun run build

    - name: âš¡ Ruff Python Sacred Linting
      run: |
        echo "âš¡ Running Ruff for Python sacred standards..."
        uv run ruff check .
        uv run ruff format --check .

    - name: ğŸ§ª Run Sacred Test Suite
      working-directory: ./frontend
      run: |
        echo "ğŸ§ª Running sacred test suite..."
        bun run test:unit --run

  agro-metrics:
    name: ğŸ“Š Sacred Metrics Calculation
    runs-on: ubuntu-latest
    needs: agro-validation

    steps:
    - name: ğŸ“¥ Checkout Sacred Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python for Metrics
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“Š Calculate Sacred Metrics
      run: |
        echo "ğŸ“Š Calculating Ï„ (tau), Ï† (phi), Î£ (sigma) sacred metrics..."

        # Count violations across codebase
        CONSOLE_VIOLATIONS=$(grep -r "console\." --include="*.js" --include="*.ts" --include="*.vue" . | wc -l || echo "0")
        PRINT_VIOLATIONS=$(grep -r "print(" --include="*.py" . | wc -l || echo "0")
        TOTAL_VIOLATIONS=$((CONSOLE_VIOLATIONS + PRINT_VIOLATIONS))

        # Calculate files
        TOTAL_FILES=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.vue" \) \
                     ! -path "./node_modules/*" ! -path "./.git/*" | wc -l)

        # Sacred metrics calculation
        if [ $TOTAL_FILES -gt 0 ]; then
          TAU_COMPLEXITY=$((TOTAL_VIOLATIONS * 5))  # Ï„ (tau) - complexity penalty
          PHI_QUALITY=$((100 - (TOTAL_VIOLATIONS * 10)))  # Ï† (phi) - quality score
          SIGMA_COLLABORATION=85  # Î£ (sigma) - collaboration efficiency
        else
          TAU_COMPLEXITY=0
          PHI_QUALITY=100
          SIGMA_COLLABORATION=100
        fi

        echo "ğŸ Sacred Metrics Report:"
        echo "Ï„ (tau) Complexity: $TAU_COMPLEXITY"
        echo "Ï† (phi) Quality: $PHI_QUALITY"
        echo "Î£ (sigma) Collaboration: $SIGMA_COLLABORATION"
        echo "Console violations: $CONSOLE_VIOLATIONS"
        echo "Print violations: $PRINT_VIOLATIONS"
        echo "Total files: $TOTAL_FILES"

        # Set outputs for potential use
        echo "tau_complexity=$TAU_COMPLEXITY" >> $GITHUB_OUTPUT
        echo "phi_quality=$PHI_QUALITY" >> $GITHUB_OUTPUT
        echo "sigma_collaboration=$SIGMA_COLLABORATION" >> $GITHUB_OUTPUT

  divine-blessing:
    name: âœ¨ Divine Blessing Assessment
    runs-on: ubuntu-latest
    needs: [agro-validation, agro-metrics]

    steps:
    - name: âœ¨ Divine Blessing Evaluation
      run: |
        echo "âœ¨ğŸ Divine Blessing Assessment ğŸâœ¨"
        echo "Sacred Justification: 'Iron sharpens iron, and one man sharpens another.'"
        echo ""

        # Simple blessing logic (can be enhanced)
        if [ "${{ needs.agro-validation.result }}" == "success" ]; then
          echo "ğŸ™ DIVINE BLESSING GRANTED ğŸ™"
          echo "Sacred code approved for the hive!"
          echo "May your commits be fruitful and multiply! ğŸâœ¨"
        else
          echo "ğŸš¨ DIVINE BLESSING WITHHELD ğŸš¨"
          echo "Console violations prevent sacred approval."
          echo "Purify your code and seek blessing again."
          exit 1
        fi